name: Daily Player Update

on:
  schedule:
    - cron: '0 3 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00 UTC
  workflow_dispatch:      # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # –ö–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–æ!

    steps:
    # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å —Ç–æ–∫–µ–Ω–æ–º
    - name: üì• Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: üì¶ Install dependencies
      run: |
        pip install requests beautifulsoup4
        
    # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤
    - name: üìÅ Check file structure
      run: |
        echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
        ls -la
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ scripts/:"
        ls -la scripts/
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–Ω—è:"
        find . -name "*.py" -o -name "*.json" | head -20
        
    # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä (—Å–Ω–∞—á–∞–ª–∞ userlist_parser, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ)
    - name: üéÆ Run player data update with levels
      run: |
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º userlist_parser.py –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Å —É—Ä–æ–≤–Ω—è–º–∏..."
        python scripts/userlist_parser.py
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º players_data.json..."
        if [ -f "players_data.json" ]; then
          echo "players_data.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          head -n 50 players_data.json
        else
          echo "–û–®–ò–ë–ö–ê: players_data.json –Ω–µ —Å–æ–∑–¥–∞–Ω!"
        fi
        
    # 6. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    - name: üîÑ Run API update
      run: |
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º core_parser.py –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ API..."
        python scripts/core_parser.py
        
    # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    - name: üîç Verify results
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ..."
        if [ -f "players_data.json" ]; then
          echo "=== –°–æ–¥–µ—Ä–∂–∏–º–æ–µ players_data.json (–ø–µ—Ä–≤—ã–µ 3 –∏–≥—Ä–æ–∫–∞) ==="
          python -c "
import json
with open('players_data.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
for i, (player_id, player_data) in enumerate(list(data.items())[:3]):
    print(f'–ò–≥—Ä–æ–∫ {player_id}: {player_data.get(\"username\", \"Unknown\")}')
    print(f'  –£—Ä–æ–≤–µ–Ω—å: {player_data.get(\"level\", \"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\")}')
    print(f'  XP: {player_data.get(\"xp\", \"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\")}')
    print(f'  –ö—Ä–µ–¥–∏—Ç—ã: {player_data.get(\"credits\", \"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\")}')
    print(f'  –ó–∞—Ä–∞–∂–µ–Ω–∏–µ: {player_data.get(\"infection\", \"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\")}%')
    print(f'  –®—ë–ø–æ—Ç: {player_data.get(\"whisper\", \"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\")}%')
    print()
          "
        else:
          echo "–û–®–ò–ë–ö–ê: players_data.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          
        echo "=== –§–∞–π–ª—ã –≤ data/players/ ==="
        ls -la data/players/ || echo "–ü–∞–ø–∫–∞ data/players/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        
    # 8. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git –∏ –ø—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    - name: üíæ Commit & Push
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –í–°–ï –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        git add data/ players_data.json scripts/
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
        if git diff --staged --quiet; then
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞."
        else
          git commit -m "ü§ñ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å —É—Ä–æ–≤–Ω—è–º–∏ $(date '+%Y-%m-%d %H:%M')"
          git push origin HEAD:main
        fi
